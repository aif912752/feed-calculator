<template>
  <div class="min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center p-4 ">
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-lg border border-blue-100 p-6">
      <div class="flex items-center justify-center mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500 mr-3">
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
        </svg>
        <h1 class="text-2xl font-bold text-blue-700">
          เครื่องคำนวณการเลี้ยงสัตว์
        </h1>
      </div>
      
      <!-- Input Form -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <a-form 
            :model="formData" 
            @finish="calculate"
            class="space-y-4"
          >
            <a-form-item 
              label="น้ำหนักเริ่มต้น (กก.)" 
              name="initialWeight"
              :rules="[{ required: true, message: 'กรุณาระบุน้ำหนักเริ่มต้น' }]"
            >
              <a-input-number 
                v-model:value="formData.initialWeight" 
                :min="0" 
                class="w-full"
                placeholder="ระบุน้ำหนักเริ่มต้น"
              />
            </a-form-item>

            <a-form-item 
              label="น้ำหนักสุดท้าย (กก.)" 
              name="finalWeight"
              :rules="[{ required: true, message: 'กรุณาระบุน้ำหนักสุดท้าย' }]"
            >
              <a-input-number 
                v-model:value="formData.finalWeight" 
                :min="0" 
                class="w-full"
                placeholder="ระบุน้ำหนักสุดท้าย"
              />
            </a-form-item>

            <a-form-item 
              label="ปริมาณอาหารทั้งหมด (กก.)" 
              name="totalFeed"
              :rules="[{ required: true, message: 'กรุณาระบุปริมาณอาหาร' }]"
            >
              <a-input-number 
                v-model:value="formData.totalFeed" 
                :min="0" 
                class="w-full"
                placeholder="ระบุปริมาณอาหารทั้งหมด"
              />
            </a-form-item>

            <a-form-item 
              label="จำนวนวันที่เลี้ยง" 
              name="days"
              :rules="[{ required: true, message: 'กรุณาระบุจำนวนวัน' }]"
            >
              <a-input-number 
                v-model:value="formData.days" 
                :min="1" 
                class="w-full"
                placeholder="ระบุจำนวนวัน"
              />
            </a-form-item>

            <a-form-item
              label="หมายเหตุ"
              name="notes"
            >
              <a-input
                v-model:value="formData.notes"
                placeholder="บันทึกเพิ่มเติม (ไม่บังคับ)"
              />
            </a-form-item>

            <a-button 
              type="primary" 
              html-type="submit" 
              class="w-full bg-blue-500 hover:bg-blue-600 transition-colors rounded-full text-white font-semibold"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 inline">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <polyline points="22 4 12 14.01 9 11.01" />
              </svg>
              คำนวณ
            </a-button>
          </a-form>

          <!-- Latest Result -->
          <div v-if="result" class="mt-6 bg-blue-50 p-4 rounded-lg shadow-sm">
            <h2 class="text-xl font-semibold text-center text-blue-700 mb-4 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                <polyline points="14 2 14 8 20 8" />
                <line x1="16" x2="8" y1="13" y2="13" />
                <line x1="16" x2="8" y1="17" y2="17" />
                <line x1="10" x2="8" y1="9" y2="9" />
              </svg>
              ผลการคำนวณล่าสุด
            </h2>
            <div class="space-y-2">
              <p class="flex justify-between text-blue-800">
                <span>อัตราการแปลงอาหาร (FCR):</span>
                <span class="font-bold">{{ result.fcr.toFixed(2) }}</span>
              </p>
              <p class="flex justify-between text-blue-800">
                <span>อัตราการเจริญเติบโตต่อวัน (ADG):</span>
                <span class="font-bold">{{ result.adg.toFixed(2) }} กก./วัน</span>
              </p>
              <p class="flex justify-between text-blue-800">
                <span>ปริมาณอาหารที่กินต่อวัน (FI):</span>
                <span class="font-bold">{{ result.fi.toFixed(2) }} กก./วัน</span>
              </p>
            </div>
          </div>
        </div>

        <!-- Calculation History -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <h2 class="text-xl font-semibold text-center text-blue-700 mb-4 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
              <path d="M12 20v-6M6 20V10M18 20V4" />
            </svg>
            ประวัติการคำนวณ
          </h2>
          
          <div class="space-y-4 max-h-[500px] overflow-y-auto">
            <div v-for="(record, index) in calculationHistory" :key="index" class="bg-white p-4 rounded-lg shadow-sm">
              <div class="flex justify-between items-start mb-2">
                <span class="text-sm text-gray-500">{{ record.date }}</span>
                <a-button 
                  type="text" 
                  class="text-red-500 hover:text-red-700"
                  @click="deleteRecord(index)"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                  </svg>
                </a-button>
              </div>
              <div class="space-y-1">
                <p class="text-sm"><span class="font-semibold">น้ำหนัก:</span> {{ record.initialWeight }} → {{ record.finalWeight }} กก.</p>
                <p class="text-sm"><span class="font-semibold">ระยะเวลา:</span> {{ record.days }} วัน</p>
                <p class="text-sm"><span class="font-semibold">อาหาร:</span> {{ record.totalFeed }} กก.</p>
                <div class="mt-2 pt-2 border-t">
                  <p class="text-sm"><span class="font-semibold">FCR:</span> {{ record.result.fcr.toFixed(2) }}</p>
                  <p class="text-sm"><span class="font-semibold">ADG:</span> {{ record.result.adg.toFixed(2) }} กก./วัน</p>
                  <p class="text-sm"><span class="font-semibold">FI:</span> {{ record.result.fi.toFixed(2) }} กก./วัน</p>
                </div>
                <p v-if="record.notes" class="text-sm text-gray-600 mt-2">
                  <span class="font-semibold">หมายเหตุ:</span> {{ record.notes }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { message } from 'ant-design-vue'

const formData = ref({
  initialWeight: null,
  finalWeight: null,
  totalFeed: null,
  days: null,
  notes: ''
})

const result = ref(null)
const calculationHistory = ref([])

// Load data from localStorage on mount
onMounted(() => {
  const savedHistory = localStorage.getItem('calculationHistory')
  if (savedHistory) {
    calculationHistory.value = JSON.parse(savedHistory)
  }
})

// Save data to localStorage
const saveHistory = () => {
  localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory.value))
}

const calculate = () => {
  const { 
    initialWeight, 
    finalWeight, 
    totalFeed, 
    days,
    notes
  } = formData.value

  // Validation
  if (!initialWeight || !finalWeight || !totalFeed || !days) {
    message.error('กรุณากรอกข้อมูลให้ครบทุกช่อง')
    return
  }

  if (finalWeight <= initialWeight) {
    message.error('น้ำหนักสุดท้ายต้องมากกว่าน้ำหนักเริ่มต้น')
    return
  }

  // Calculations
  const fcr = totalFeed / (finalWeight - initialWeight)
  const adg = (finalWeight - initialWeight) / days
  const fi = totalFeed / days

  const newResult = { fcr, adg, fi }
  result.value = newResult

  // Add to history
  const newRecord = {
    date: new Date().toLocaleString('th-TH'),
    initialWeight,
    finalWeight,
    totalFeed,
    days,
    notes,
    result: newResult
  }

  calculationHistory.value.unshift(newRecord)
  saveHistory()
  message.success('คำนวณเสร็จสิ้นและบันทึกแล้ว')
}

const deleteRecord = (index) => {
  calculationHistory.value.splice(index, 1)
  saveHistory()
  message.success('ลบรายการเรียบร้อย')
}
</script>